{% extends 'base.html' %} {% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-8 col-lg-6">
    <h2 class="mb-3 text-center">Registrar Guía Nueva</h2>
    <form method="POST" class="card p-4 shadow-sm">
      {{ form.hidden_tag() }}
      <div class="mb-3">
        {{ form.tracking.label(class="form-label") }}
        {{ form.tracking(class="form-control form-control-lg") }}
        <button type="button" class="btn btn-info mt-2 w-100" onclick="startScanner('tracking')">Escanear Tracking</button>
        <div id="reader-tracking" class="scanner-container mt-2"></div>
      </div>
      <div class="mb-3">
        {{ form.guia_internacional.label(class="form-label") }}
        {{ form.guia_internacional(class="form-control form-control-lg") }}
        <button type="button" class="btn btn-info mt-2 w-100" onclick="startScanner('guia_internacional')">Escanear Guía Internacional</button>
        <div id="reader-guia-internacional" class="scanner-container mt-2"></div>
      </div>
      <div class="mb-3 d-grid gap-2">
        {{ form.submit(class="btn btn-primary btn-lg") }}
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary btn-lg">Cancelar</a>
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block scripts %}
<!-- Usar la versión local de html5-qrcode -->
<script src="/static/js/html5-qrcode.min.js"></script>
<script>
  // No es necesario verificar Html5Qrcode aquí, ya se hace en scanner.js
  // y el mensaje se mostrará en el div de escaneo si hay un problema.
</script>
<script src="/static/js/scanner.js"></script>
<script>
  let currentScanField = '';

  function startScanner(field) {
    currentScanField = field;
    // La lógica de scanner.js ya maneja el inicio del escáner con un ID de lector dinámico.
    // Asegúrate de que el div 'reader-tracking' o 'reader-guia-internacional' exista.
    startScannerLogic(`reader-${field}`);
  }

  // Esta función es para el escaneo manual en el formulario de registro,
  // no para el proceso de dos pasos de /scan.
  function submitCode(code) {
    if (currentScanField === 'tracking') {
      document.getElementById('tracking').value = code;
    } else if (currentScanField === 'guia_internacional') {
      document.getElementById('guia_internacional').value = code;
    }
    // Detener el escáner después de un escaneo exitoso en el formulario de registro
    if (html5QrCodeInstance) {
      html5QrCodeInstance.stop().catch(() => {});
      html5QrCodeInstance = null;
    }
    showSuccessScan(currentScanField, code);
  }

  function showSuccessScan(field, code) {
    const msgDiv = document.getElementById(`reader-${field}`);
    if (msgDiv) {
      msgDiv.innerHTML = `<div class="alert alert-success mt-2">Código <strong>${code}</strong> escaneado para <strong>${field}</strong>.</div>`;
    }
  }

  // Asegurarse de que showError y showInfo de scanner.js estén disponibles globalmente
  // No es necesario redefinirlas aquí si ya están en scanner.js
</script>
{% endblock %}
