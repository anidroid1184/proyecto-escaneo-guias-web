{% extends 'base.html' %} {% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-8 col-lg-6">
    <h2 class="mb-3 text-center">Registrar Guía Nueva</h2>
    <form method="POST" class="card p-4 shadow-sm">
      {{ form.hidden_tag() }}
      <div class="mb-3">
        {{ form.tracking.label(class="form-label") }}
        <div class="input-group mb-2">
          {{ form.tracking(class="form-control form-control-lg", id="tracking")
          }}
          <button
            type="button"
            class="btn btn-info"
            onclick="startScannerLogic('reader-tracking')"
          >
            Escanear
          </button>
        </div>
        <div id="reader-tracking" class="scanner-container mt-2"></div>
      </div>
      <div class="mb-3">
        {{ form.guia_internacional.label(class="form-label") }}
        <div class="input-group mb-2">
          {{ form.guia_internacional(class="form-control form-control-lg",
          id="guia_internacional") }}
          <button
            type="button"
            class="btn btn-info"
            onclick="startScannerLogic('reader-guia-internacional')"
          >
            Escanear
          </button>
        </div>
        <div
          id="reader-guia-internacional"
          class="scanner-container mt-2"
        ></div>
      </div>
      {% if request.args.get('tracking') or
      request.args.get('guia_internacional') %}
      <div class="mb-3">
        <label class="form-label"
          >¿A qué campo asignar el código detectado?</label
        >
        <div class="form-check form-switch d-flex align-items-center gap-2">
          <input
            class="form-check-input"
            type="checkbox"
            id="toggleTipo"
            onchange="asignarCodigoToggle()"
          />
          <label class="form-check-label" for="toggleTipo" id="toggleLabel"
            >Tracking</label
          >
        </div>
        <button
          class="btn btn-primary mt-2 w-100"
          onclick="asignarCodigoYLimpiar()"
        >
          Asignar código
        </button>
      </div>
      <script>
        // Guardar el código detectado
        const codigoDetectado =
          "{{ request.args.get('tracking', request.args.get('guia_internacional', '')) }}";
        // Por defecto, el toggle está en Tracking
        function asignarCodigoToggle() {
          const toggle = document.getElementById("toggleTipo");
          const label = document.getElementById("toggleLabel");
          if (toggle.checked) {
            label.textContent = "Guía Internacional";
          } else {
            label.textContent = "Tracking";
          }
        }
        function asignarCodigoYLimpiar() {
          const toggle = document.getElementById("toggleTipo");
          if (toggle.checked) {
            document.getElementById("guia_internacional").value =
              codigoDetectado;
            document.getElementById("tracking").value = "";
          } else {
            document.getElementById("tracking").value = codigoDetectado;
            document.getElementById("guia_internacional").value = "";
          }
        }
      </script>
      {% endif %}
      <div class="mb-3 d-grid gap-2">
        {{ form.submit(class="btn btn-primary btn-lg") }}
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary btn-lg"
          >Cancelar</a
        >
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block scripts %}
<!-- Usar la versión local de html5-qrcode -->
<script src="/static/js/html5-qrcode.min.js"></script>
<script>
  // No es necesario verificar Html5Qrcode aquí, ya se hace en scanner.js
  // y el mensaje se mostrará en el div de escaneo si hay un problema.
</script>
<script src="/static/js/scanner.js"></script>
<script>
  let currentScanField = '';

  // Esta función es para el escaneo manual en el formulario de registro,
  // no para el proceso de dos pasos de /scan.
  function submitCode(code) {
    // Determinar qué campo se está escaneando basándose en el ID del lector activo
    const activeReaderId = html5QrCodeInstance ? html5QrCodeInstance.get
    if (document.getElementById('reader-tracking').style.display === 'block') {
        document.getElementById('tracking').value = code;
        currentScanField = 'tracking';
    } else if (document.getElementById('reader-guia-internacional').style.display === 'block') {
        document.getElementById('guia_internacional').value = code;
        currentScanField = 'guia_internacional';
    }

    // Detener el escáner después de un escaneo exitoso en el formulario de registro
    if (html5QrCodeInstance) {
      html5QrCodeInstance.stop().catch(() => {});
      html5QrCodeInstance = null;
    }
    showSuccessScan(currentScanField, code);
  }

  function showSuccessScan(field, code) {
    const msgDiv = document.getElementById(`reader-${field}`);
    if (msgDiv) {
      msgDiv.innerHTML = `<div class="alert alert-success mt-2">Código <strong>${code}</strong> escaneado para <strong>${field}</strong>.</div>`;
    }
  }

  // Envío automático del formulario si se llega con tracking o guia_internacional por GET
  document.addEventListener('DOMContentLoaded', function() {
    const tracking = document.getElementById('tracking');
    const guia = document.getElementById('guia_internacional');
    const form = document.querySelector('form');
    // Si alguno de los campos tiene valor (vía GET), enviar el formulario automáticamente
    if ((tracking && tracking.value) || (guia && guia.value)) {
      setTimeout(() => { form.submit(); }, 300); // Pequeño delay para que el campo se pinte
    }
    // Mostrar alert si fue exitoso (flash message)
    const successAlert = document.querySelector('.alert-success');
    if (successAlert && successAlert.textContent.includes('registrada')) {
      alert(successAlert.textContent);
    }
  });
</script>
{% endblock %}
<script>
  // Envío automático del formulario si se llega con tracking o guia_internacional por GET
  document.addEventListener("DOMContentLoaded", function () {
    const tracking = document.getElementById("tracking");
    const guia = document.getElementById("guia_internacional");
    const form = document.querySelector("form");
    // Si alguno de los campos tiene valor (vía GET), enviar el formulario automáticamente
    if ((tracking && tracking.value) || (guia && guia.value)) {
      setTimeout(() => {
        form.submit();
      }, 200); // Pequeño delay para que el campo se pinte
    }
  });
</script>
