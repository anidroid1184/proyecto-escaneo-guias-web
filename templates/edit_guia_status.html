{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
        <h2 class="mb-3 text-center">Editar Estado de Guía</h2>
        {% if guia_status and guia and current_session %}
        <p><strong>Tracking:</strong> <span id="display-tracking">{{ guia.tracking }}</span></p>
        <p><strong>Guía Internacional:</strong> <span id="display-guia-internacional">{{ guia.guia_internacional }}</span></p>
    <p><strong>Sesión:</strong> {% if current_session %}{{ current_session.session_date.strftime('%Y-%m-%d') }}{% else %}Sin sesión activa{% endif %}</p>
        <p><strong>Estado Actual:</strong> {{ guia_status.status }}</p>

        <form method="POST" id="edit-guia-form">
            <div class="mb-3">
                <label for="new_status" class="form-label">Nuevo Estado</label>
                <select name="new_status" id="new_status" class="form-select" required>
                    <option value="RECIBIDO" {% if guia_status.status == 'RECIBIDO' %}selected{% endif %}>RECIBIDO</option>
                    <option value="NO RECIBIDO" {% if guia_status.status == 'NO RECIBIDO' %}selected{% endif %}>NO RECIBIDO</option>
                    <option value="NO ESPERADO" {% if guia_status.status == 'NO ESPERADO' %}selected{% endif %}>NO ESPERADO</option>
                    <option value="NO ESCANEADO" {% if guia_status.status == 'NO ESCANEADO' %}selected{% endif %}>NO ESCANEADO</option>
                </select>
            </div>

            <hr class="my-4">

            <h3>Escanear o Ingresar Código para Actualizar Guía</h3>
            <p>Escanea o ingresa el código (Tracking o Guía Internacional) para actualizar la guía. Se te pedirá confirmar qué campo deseas modificar.</p>
            
            <div class="mb-3">
                <label for="scanned_code_input" class="form-label">Código Escaneado/Ingresado</label>
                <input type="text" id="scanned_code_input" name="scanned_code" class="form-control" placeholder="Escanea o ingresa el código manualmente">
            </div>
            <div class="mb-3 d-grid gap-2 d-md-flex justify-content-md-center">
                <button type="button" class="btn btn-info btn-lg flex-fill" onclick="startScannerLogic('reader-edit_guia_scanner')">Iniciar Escáner</button>
                <button type="button" class="btn btn-secondary btn-lg flex-fill" onclick="clearScannedCodeInput()">Limpiar Código</button>
            </div>
            <div id="reader-edit_guia_scanner" class="scanner-container mt-2"></div>
            <div id="scan-message-edit" class="mt-3 text-center"></div>
            <!-- Contenedor para el popup de confirmación de actualización -->
            <div id="update-confirmation-popup" class="mt-3 text-center"></div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button type="submit" class="btn btn-primary btn-lg">Guardar Cambios</button>
                <a href="{{ url_for('records.registros', session_id=current_session.id) }}" class="btn btn-secondary btn-lg">Cancelar</a>
            </div>
        </form>

        {% else %}
        <div class="alert alert-danger">No se encontró la información de la guía o sesión.</div>
        <a href="{{ url_for('records.registros') }}" class="btn btn-primary">Ver Registros</a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Usar la versión local de html5-qrcode -->
<script src="/static/js/html5-qrcode.min.js"></script>
<script src="/static/js/scanner.js"></script>
<script>
    // No redeclarar html5QrCodeInstance y scanMessageTimeout, ya son globales de scanner.js
    // let html5QrCodeInstance = null; 
    // let scanMessageTimeout; 

    // Sobrescribir o extender las funciones de scanner.js para esta página,
    // pasando el ID del div de mensajes específico de esta vista.
    function showScannerStatusEdit(message, type = 'info') {
        showScannerStatus(message, type, 'scan-message-edit');
    }

    function showErrorEdit(error) {
        showError(error, 'scan-message-edit');
    }

    function showSuccessEdit(message) {
        showSuccess(message, 'scan-message-edit');
    }

    // Sobrescribir o extender las funciones de scanner.js para esta página,
    // pasando el ID del div de mensajes específico de esta vista.
    function showScannerStatusEdit(message, type = 'info') {
        showScannerStatus(message, type, 'scan-message-edit');
    }

    function showErrorEdit(error) {
        showError(error, 'scan-message-edit');
    }

    function showSuccessEdit(message) {
        showSuccess(message, 'scan-message-edit');
    }

    // Nueva función para mostrar el popup de confirmación de actualización
    function showUpdateConfirmationPrompt(code, currentTracking, currentGuiaInternacional) {
        const popupDiv = document.getElementById('update-confirmation-popup');
        let optionsHtml = '';

        // Opción para actualizar Tracking
        if (!currentTracking || currentTracking !== code) {
            optionsHtml += `<button class="btn btn-sm btn-primary me-2" onclick="confirmUpdateField('${code}', 'tracking')">Actualizar Tracking</button>`;
        } else {
            optionsHtml += `<button class="btn btn-sm btn-secondary me-2" disabled>Tracking ya es este</button>`;
        }

        // Opción para actualizar Guía Internacional
        if (!currentGuiaInternacional || currentGuiaInternacional !== code) {
            optionsHtml += `<button class="btn btn-sm btn-primary me-2" onclick="confirmUpdateField('${code}', 'guia_internacional')">Actualizar Guía Internacional</button>`;
        } else {
            optionsHtml += `<button class="btn btn-sm btn-secondary me-2" disabled>Guía Int. ya es este</button>`;
        }

        // Opción para reemplazar ambos (si ambos son diferentes)
        if ((!currentTracking || currentTracking !== code) && (!currentGuiaInternacional || currentGuiaInternacional !== code)) {
             optionsHtml += `<button class="btn btn-sm btn-warning me-2" onclick="confirmUpdateField('${code}', 'both')">Reemplazar Ambos</button>`;
        }

        popupDiv.innerHTML = `
            <div class="alert alert-info">
                Código escaneado: <strong>${code}</strong>. ¿Qué campo deseas actualizar?<br>
                ${optionsHtml}
                <button class="btn btn-sm btn-danger" onclick="cancelUpdate()">Cancelar</button>
            </div>
        `;
        // Pausar el escáner mientras el popup está activo
        if (html5QrCodeInstance) {
            html5QrCodeInstance.pause();
        }
    }

    function confirmUpdateField(code, fieldType) {
        const currentTracking = document.getElementById('display-tracking').textContent;
        const currentGuiaInternacional = document.getElementById('display-guia-internacional').textContent;

        let updateData = {
            guia_id: {{ guia.id }},
            session_id: {{ current_session.id }},
            scanned_code: code,
            field_type: fieldType,
            current_tracking: currentTracking,
            current_guia_internacional: currentGuiaInternacional
        };

        fetch('/update_guia_fields', { // Nueva ruta para actualizar campos específicos
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                showErrorEdit(data.message || data.error);
            } else {
                showSuccessEdit(data.message);
                if (data.tracking !== undefined) {
                    document.getElementById('display-tracking').textContent = data.tracking || 'N/A';
                }
                if (data.guia_internacional !== undefined) {
                    document.getElementById('display-guia-internacional').textContent = data.guia_internacional || 'N/A';
                }
                // --- Actualizar footer ---
                if (data.total_scanned_packages !== undefined) {
                    const footerEscaneados = document.getElementById('footer-escaneados');
                    if (footerEscaneados) footerEscaneados.textContent = data.total_scanned_packages;
                }
                if (data.total_packages !== undefined && data.total_scanned_packages !== undefined) {
                    const footerFaltantes = document.getElementById('footer-faltantes');
                    if (footerFaltantes) footerFaltantes.textContent = (data.total_packages - data.total_scanned_packages);
                }
                if (data.not_registered_packages !== undefined) {
                    const footerNoEsperados = document.getElementById('footer-no-esperados');
                    if (footerNoEsperados) footerNoEsperados.textContent = data.not_registered_packages;
                }
                // --- Fin actualización footer ---
            }
        })
        .catch(error => {
            console.error('Error en la solicitud fetch para actualizar campos:', error);
            showErrorEdit('Error de comunicación con el servidor al actualizar campos. Detalles: ' + error.message);
        })
        .finally(() => {
            document.getElementById('update-confirmation-popup').innerHTML = ''; // Limpiar popup
            if (html5QrCodeInstance) {
                html5QrCodeInstance.resume(); // Reanudar el escáner
            }
            document.getElementById("scanned_code_input").value = ''; // Limpiar input
        });
    }

    function cancelUpdate() {
        document.getElementById('update-confirmation-popup').innerHTML = ''; // Limpiar popup
        if (html5QrCodeInstance) {
            html5QrCodeInstance.resume(); // Reanudar el escáner
        }
        document.getElementById("scanned_code_input").value = ''; // Limpiar input
        showScannerStatusEdit("Actualización cancelada. Listo para escanear.");
    }

    function processScannedCode(code) { // Esta función es llamada por scanner.js
        document.getElementById("scanned_code_input").value = code; // Mostrar el código escaneado en el input
        const currentTracking = document.getElementById('display-tracking').textContent;
        const currentGuiaInternacional = document.getElementById('display-guia-internacional').textContent;
        
        showUpdateConfirmationPrompt(code, currentTracking, currentGuiaInternacional);
    }

    function clearScannedCodeInput() {
        document.getElementById("scanned_code_input").value = '';
        showScannerStatusEdit("Código limpiado. Listo para escanear.");
    }

    // Manejar el envío del formulario unificado (solo para el cambio de estado)
    document.getElementById('edit-guia-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevenir el envío normal del formulario

        const newStatus = document.getElementById('new_status').value;
        const currentTracking = document.getElementById('display-tracking').textContent;
        const currentGuiaInternacional = document.getElementById('display-guia-internacional').textContent;
        const scannedInput = document.getElementById('scanned_code_input').value.trim();

        // Si hay código en el input, mostrar el popup de confirmación igual que con el escaneo
        if (scannedInput) {
            showUpdateConfirmationPrompt(scannedInput, currentTracking, currentGuiaInternacional);
            return; // No continuar con el submit normal
        }

        // Si no hay código, solo guardar el estado normalmente
        const formData = {
            new_status: newStatus,
            tracking: currentTracking === 'N/A' ? null : currentTracking, // Enviar null si es N/A
            guia_internacional: currentGuiaInternacional === 'N/A' ? null : currentGuiaInternacional // Enviar null si es N/A
        };

        showScannerStatusEdit("Guardando cambios...", 'info');

        fetch('/edit_guia_status/{{ guia.id }}/{{ current_session.id }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(res => {
            if (!res.ok) {
                return res.text().then(text => { throw new Error(text) });
            }
            return res.json();
        })
        .then(data => {
            if (data.error) {
                showErrorEdit(data.message || data.error);
            } else {
                showSuccessEdit(data.message);
                // Actualizar el estado actual mostrado
                if (data.new_status !== undefined) {
                    const statusElement = Array.from(document.querySelectorAll('p strong')).find(el => el.textContent.includes('Estado Actual:'));
                    if (statusElement && statusElement.nextSibling) {
                        statusElement.nextSibling.textContent = data.new_status;
                    }
                }
                // --- Actualizar footer ---
                if (data.total_scanned_packages !== undefined) {
                    const footerEscaneados = document.getElementById('footer-escaneados');
                    if (footerEscaneados) footerEscaneados.textContent = data.total_scanned_packages;
                }
                if (data.total_packages !== undefined && data.total_scanned_packages !== undefined) {
                    const footerFaltantes = document.getElementById('footer-faltantes');
                    if (footerFaltantes) footerFaltantes.textContent = (data.total_packages - data.total_scanned_packages);
                }
                if (data.not_registered_packages !== undefined) {
                    const footerNoEsperados = document.getElementById('footer-no-esperados');
                    if (footerNoEsperados) footerNoEsperados.textContent = data.not_registered_packages;
                }
                // --- Fin actualización footer ---
                // Redirigir si el backend lo indica
                if (data.redirect_to_records) {
                    window.location.href = "{{ url_for('records.registros', session_id=current_session.id) }}";
                }
            }
        })
        .catch(error => {
            console.error('Error en la solicitud fetch para guardar cambios:', error);
            showErrorEdit('Error de comunicación con el servidor al guardar los cambios. Detalles: ' + error.message);
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        startScannerLogic('reader-edit_guia_scanner'); // Iniciar escáner automáticamente
        showScannerStatusEdit("Listo para escanear.");
    });

    // Inicializar contadores del footer
    document.addEventListener('DOMContentLoaded', function() {
        const escaneados = document.getElementById('footer-escaneados');
        const faltantes = document.getElementById('footer-faltantes');
        const noEsperados = document.getElementById('footer-no-esperados');

        const totalScanned = Number({{ footer_counts.total_scanned_packages | default(0) }});
        const totalPackages = Number({{ footer_counts.total_packages | default(0) }});
        const notRegistered = Number({{ footer_counts.not_registered_packages | default(0) }});
        if (escaneados && faltantes && noEsperados) {
            escaneados.textContent = totalScanned;
            faltantes.textContent = (totalPackages - totalScanned) >= 0 ? (totalPackages - totalScanned) : 0;
            noEsperados.textContent = notRegistered;
        }
    });
</script>
{% endblock %}

{% include 'footer_counter.html' %}
