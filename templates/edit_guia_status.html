{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
        <h2 class="mb-3 text-center">Editar Estado de Guía</h2>
        {% if guia_status and guia and current_session %}
        <p><strong>Tracking:</strong> <span id="display-tracking">{{ guia.tracking }}</span></p>
        <p><strong>Guía Internacional:</strong> <span id="display-guia-internacional">{{ guia.guia_internacional }}</span></p>
        <p><strong>Sesión:</strong> {{ current_session.session_date.strftime('%Y-%m-%d') }}</p>
        <p><strong>Estado Actual:</strong> {{ guia_status.status }}</p>

        <form method="POST">
            <div class="mb-3">
                <label for="new_status" class="form-label">Nuevo Estado</label>
                <select name="new_status" id="new_status" class="form-select" required>
                    <option value="RECIBIDO" {% if guia_status.status == 'RECIBIDO' %}selected{% endif %}>RECIBIDO</option>
                    <option value="NO RECIBIDO" {% if guia_status.status == 'NO RECIBIDO' %}selected{% endif %}>NO RECIBIDO</option>
                    <option value="NO ESPERADO" {% if guia_status.status == 'NO ESPERADO' %}selected{% endif %}>NO ESPERADO</option>
                    <option value="NO ESCANEADO" {% if guia_status.status == 'NO ESCANEADO' %}selected{% endif %}>NO ESCANEADO</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Actualizar Estado</button>
            <a href="{{ url_for('records.registros', session_id=current_session.id) }}" class="btn btn-secondary ms-2">Cancelar</a>
        </form>

        <hr class="my-4">

        <h3>Escanear para Actualizar Guía</h3>
        <p>Si la guía tiene un código incorrecto o falta, escanéalo aquí para actualizarla.</p>
        
        <div class="mb-3">
            <label class="form-label">¿Qué campo deseas escanear/actualizar?</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="scan_field_choice" id="scan_tracking" value="tracking" checked>
                <label class="form-check-label" for="scan_tracking">
                    Solo Tracking
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="scan_field_choice" id="scan_guia_internacional" value="guia_internacional">
                <label class="form-check-label" for="scan_guia_internacional">
                    Solo Guía Internacional
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="scan_field_choice" id="scan_both" value="both">
                <label class="form-check-label" for="scan_both">
                    Ambos (escanear dos veces)
                </label>
            </div>
        </div>

        <div class="mb-3">
            <label for="scanned_code_input" class="form-label">Código Escaneado (Tracking o Guía Internacional)</label>
            <input type="text" id="scanned_code_input" class="form-control" placeholder="Escanea o ingresa el código manualmente">
        </div>
        <div class="mb-3 d-grid gap-2 d-md-flex justify-content-md-center">
            <button type="button" class="btn btn-info btn-lg flex-fill" onclick="startScanner('edit_guia_scanner')">Iniciar Escáner</button>
            <button type="button" class="btn btn-success btn-lg flex-fill" onclick="submitManualEdit()">Actualizar Manualmente</button>
        </div>
        <div id="reader-edit_guia_scanner" class="scanner-container mt-2"></div>
        <div id="scan-message-edit" class="mt-3 text-center"></div>

        {% else %}
        <div class="alert alert-danger">No se encontró la información de la guía o sesión.</div>
        <a href="{{ url_for('records.registros') }}" class="btn btn-primary">Ver Registros</a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Usar la versión local de html5-qrcode -->
<script src="/static/js/html5-qrcode.min.js"></script>
<script src="/static/js/scanner.js"></script>
<script>
    // No redeclarar html5QrCodeInstance y scanMessageTimeout, ya son globales de scanner.js
    // let html5QrCodeInstance = null; 
    // let scanMessageTimeout; 

    // Sobrescribir o extender las funciones de scanner.js para esta página,
    // pasando el ID del div de mensajes específico de esta vista.
    function showScannerStatusEdit(message, type = 'info') {
        showScannerStatus(message, type, 'scan-message-edit');
    }

    function showErrorEdit(error) {
        showError(error, 'scan-message-edit');
    }

    function showSuccessEdit(message) {
        showSuccess(message, 'scan-message-edit');
    }

    // Las funciones startScanner y submitManualEdit ya están bien definidas en el HTML
    // y llaman a las funciones globales de scanner.js.

    let currentScanStep = 0; // 0: no scanning, 1: tracking, 2: guia_internacional
    let scannedTrackingCode = '';
    let scannedGuiaInternacionalCode = '';

    function processScannedCode(code) { // Esta función es llamada por scanner.js
        const choice = document.querySelector('input[name="scan_field_choice"]:checked').value;
        
        if (choice === 'tracking') {
            sendUpdateCodeRequest(code, 'tracking');
        } else if (choice === 'guia_internacional') {
            sendUpdateCodeRequest(code, 'guia_internacional');
        } else if (choice === 'both') {
            if (currentScanStep === 0) {
                scannedTrackingCode = code;
                showScannerStatusEdit(`Tracking escaneado: ${code}. Ahora escanea la Guía Internacional.`);
                currentScanStep = 1;
                // Reiniciar escáner para el siguiente código
                if (html5QrCodeInstance) {
                    html5QrCodeInstance.stop().catch(() => {});
                    html5QrCodeInstance = null;
                }
                startScannerLogic('reader-edit_guia_scanner'); // Reiniciar escáner
            } else if (currentScanStep === 1) {
                scannedGuiaInternacionalCode = code;
                showScannerStatusEdit(`Guía Internacional escaneada: ${code}. Procesando ambos códigos...`);
                sendUpdateCodeRequest(scannedTrackingCode, 'tracking');
                sendUpdateCodeRequest(scannedGuiaInternacionalCode, 'guia_internacional');
                currentScanStep = 0; // Reset
                scannedTrackingCode = '';
                scannedGuiaInternacionalCode = '';
            }
        }
    }

    function submitManualEdit() {
        const code = document.getElementById("scanned_code_input").value.trim();
        if (!code) {
            showErrorEdit("Por favor ingresa un código.");
            return;
        }
        processScannedCode(code); // Usar la misma lógica que el escaneo
    }

    function sendUpdateCodeRequest(code, field_to_update) {
        showScannerStatusEdit(`Código escaneado: ${code}. Actualizando guía...`);
        fetch('/edit_guia_status/{{ guia.id }}/{{ current_session.id }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ scanned_code: code, action: 'update_code', field: field_to_update })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                showErrorEdit(data.message || data.error);
            } else {
                showSuccessEdit(data.message);
                // Actualizar los valores mostrados en la página
                document.getElementById('display-tracking').textContent = data.tracking || 'N/A';
                document.getElementById('display-guia-internacional').textContent = data.guia_internacional || 'N/A';
            }
        })
        .catch(() => {
            showErrorEdit('Error de comunicación con el servidor al actualizar la guía.');
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        showScannerStatusEdit("Listo para escanear.");
    });
</script>
{% endblock %}
